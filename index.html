<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        body {
            padding: 0;
            margin: 0;
            background-color: black;
            color: white;
        }

        #ascii {
            font-family: monospace;
            display:inline-block;
        }
    </style>
</head>
<body>
    <input type="file" name="" id="target-file" accept=".jpg, .jpeg, .png, .webp">
    <div>
        <p id="ascii"></p>
    </div>
    <div>
        <canvas id="canvas"></canvas>
    </div>
</body>
</html>

<script>

    const canvas = document.querySelector("#canvas"),
          ctx = canvas.getContext("2d");

    const input = document.querySelector("#target-file");

    // const chars = ['#', '$', '-', '.', '&#96;'],
    const chars = ".,:ilwW".split(""),
          chunk_size = 255 / (chars.length - 1);

    const rgb_weights = [0.2126, 0.7152, 0.0722];

    const out_container = document.querySelector("#ascii");

    const img_width = 200;
    

    out_container.style.lineHeight = 600 / img_width + "px";
    out_container.style.fontSize = 600 / img_width + "px";


    let image, image_data;

    input.addEventListener("change", () => {
        image = new Image;
        image.src = URL.createObjectURL(input.files[0]);
        console.log(image.width);

        image.onload = () => {
            canvas.width = img_width;
            canvas.height = img_width * image.height / image.width;
            ctx.drawImage(image, 0, 0, img_width, canvas.height);

            image_data = ctx.getImageData(0, 0, canvas.width, canvas.height)
            convert(ctx.getImageData(0, 0, canvas.width, canvas.height))
        }
    })



    const convert = image_data => {
        const pixel_data = image_data.data;

        let out = [];

        for (let r = 0; r < image_data.height; r++) {
            out.push("");
            
            for (let c = 0; c < image_data.width; c++) {
                const i = r * (image_data.width * 4) + c * 4;

                const mono_color =
                    pixel_data[i + 0] * rgb_weights[0] +
                    pixel_data[i + 1] * rgb_weights[1] +
                    pixel_data[i + 2] * rgb_weights[2]
                ;

                const char = Math.round(mono_color / chunk_size);

                out[r] += chars[char] + " ";
            }
        }

        out_container.innerHTML = out.join("<br>");
    }

    

</script>